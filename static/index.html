<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>空调控制面板</title>
    <link id="favicon" rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='42' fill='%23999'/%3E%3C/svg%3E" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0b1020;
            --card: #111831;
            --card-2: #0d142a;
            --text: #e7ebff;
            --muted: #9aa3c7;
            --primary: #6ea8fe;
            --accent: #7cf2d4;
            --danger: #ff6b6b;
            --ok: #7efc86;
            --red: #e73e3e;
            --blue: #7dc3ff;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 500px at 10% -10%, #152046 10%, transparent 60%),
                radial-gradient(1000px 500px at 110% 10%, #1b2552 5%, transparent 50%),
                linear-gradient(180deg, #0a0f1f, #0a0f1f 60%);
            color: var(--text);
            font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"
        }

        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 20px
        }

        .header {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 18px;
            margin-bottom: 22px;
            align-items: center
        }

        .header-left {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 84px;
            height: 84px
        }

        .header-right {
            min-height: 84px;
            display: flex;
            flex-direction: column;
            justify-content: center
        }

        .title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: .3px;
            margin: 0;
            line-height: 1
        }

        .status-badge {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            align-self: center;
            line-height: 1
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 14px
        }

        button.btn {
            appearance: none;
            border: none;
            padding: 11px 14px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: .2px;
            color: #0a0f1f;
            background: #e7ebff;
            transition: transform .08s ease, opacity .2s ease, box-shadow .2s ease
        }

        button.btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .btn.primary {
            background: linear-gradient(180deg, var(--primary), #5a8ef0);
            color: #071227;
            box-shadow: 0 6px 16px rgba(110, 168, 254, .35)
        }

        .btn.secondary {
            background: linear-gradient(180deg, #303a62, #232a4b);
            color: #d7defd;
            border: 1px solid rgba(124, 242, 212, .2)
        }

        .btn.danger {
            background: linear-gradient(180deg, #e05757, var(--danger));
            color: #2b0b0b;
            box-shadow: 0 6px 16px rgba(255, 107, 107, .35)
        }

        .btn:active {
            transform: translateY(1px)
        }

        .fan {
            width: 84px;
            height: 84px;
            position: relative;
            display: grid;
            place-items: center;
            background: radial-gradient(circle at 50% 50%, #0c1430, #070c1b);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, .07)
        }

        .fan .indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--muted);
            transition: background-color .4s ease, transform .4s ease;
            box-shadow: 0 0 0 0 rgba(126, 252, 134, .0)
        }

        .fan.on .indicator {
            background: var(--ok);
            animation: pulse 1.6s ease-in-out infinite
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(126, 252, 134, .35)
            }

            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 10px rgba(126, 252, 134, .12)
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(126, 252, 134, .0)
            }
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            overflow: hidden
        }

        .card-inner {
            padding: 22px 22px 10px 22px;
        }

        .chart-wrap {
            padding: 8px 16px 16px
        }

        .legend {
            display: flex;
            gap: 14px;
            align-items: center;
            margin: 0 0 6px 6px;
            color: var(--muted);
            font-size: 13px
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%
        }

        .dot.red {
            background: var(--red)
        }

        .dot.blue {
            background: var(--blue)
        }

        .footer-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 10px 18px 18px
        }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: rgba(20, 28, 54, .96);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .1);
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
            display: flex;
            gap: 10px;
            align-items: center;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity .2s ease, transform .2s ease;
            z-index: 10
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0)
        }

        .toast .close {
            cursor: pointer;
            opacity: .8
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
            background-size: 200% 100%;
            animation: shimmer 1.2s ease-in-out infinite
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0
            }

            100% {
                background-position: -200% 0
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="fan" id="fan">
                    <div class="indicator"></div>
                </div>
            </div>
            <div class="header-right">
                <div class="title-row">
                    <h1 class="title">空调控制面板</h1>
                    <span class="status-badge" id="statusBadge">未知</span>
                </div>
                <div class="actions">
                    <button id="btnOn" class="btn primary" type="button">开启</button>
                    <button id="btnOff" class="btn danger" type="button">关闭</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-inner">
                <div style="font-weight:700;margin-bottom:8px">温湿度趋势</div>
                <div class="legend">
                    <span class="dot red"></span><span>温度 (°C)</span>
                    <span class="dot blue" style="margin-left:10px"></span><span>湿度 (%)</span>
                </div>
            </div>
            <div class="chart-wrap">
                <canvas id="chart" height="220"></canvas>
            </div>
            <div class="footer-actions">
                <button id="btnMeasure" class="btn secondary" type="button">手动测量一次</button>
                <button id="btnRefresh" class="btn secondary" type="button">刷新</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden>
        <span id="toastText">提示</span>
        <span class="close" id="toastClose" aria-label="关闭">✕</span>
    </div>

    <script>
        (function () {
            const $ = (sel) => document.querySelector(sel);
            const fan = $('#fan');
            const statusBadge = $('#statusBadge');
            const btnOn = $('#btnOn');
            const btnOff = $('#btnOff');
            const btnMeasure = $('#btnMeasure');
            const btnRefresh = $('#btnRefresh');
            const toastEl = $('#toast');
            const toastText = $('#toastText');
            const toastClose = $('#toastClose');

            let chart, maxPoints = 10;

            function showToast(msg) {
                toastText.textContent = msg;
                toastEl.hidden = false;
                requestAnimationFrame(() => toastEl.classList.add('show'));
                const hide = () => { toastEl.classList.remove('show'); setTimeout(() => toastEl.hidden = true, 200) };
                const t = setTimeout(hide, 2800);
                toastClose.onclick = () => { clearTimeout(t); hide(); }
            }

            function setLoading(el, isLoading) {
                if (!el) return;
                el.disabled = !!isLoading;
                if (isLoading) { el.dataset._text = el.textContent; el.textContent = '处理中…'; el.setAttribute('aria-busy', 'true'); }
                else { if (el.dataset._text) el.textContent = el.dataset._text; el.removeAttribute('aria-busy'); }
            }

            function formatTime(ts) {
                try { const d = new Date(ts); const h = String(d.getHours()).padStart(2, '0'); const m = String(d.getMinutes()).padStart(2, '0'); return `${h}:${m}`; }
                catch { return '' }
            }

            // 简洁的 favicon：开启为绿色发光圆点，关闭为灰色
            function setFavicon(isOn) {
                const fill = isOn ? '%237efc86' : '%23999';
                const glow = isOn ? '%2300ffb3' : '%23999';
                const svg = `%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cfilter id='g'%3E%3CfeGaussianBlur stdDeviation='6'/%3E%3C/filter%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='22' fill='${fill}'/%3E%3Ccircle cx='50' cy='50' r='22' fill='${glow}' opacity='.35' filter='url(%23g)'/%3E%3C/svg%3E`;
                document.getElementById('favicon').setAttribute('href', `data:image/svg+xml,${svg}`);
            }

            function setStatus(isOn) {
                fan.classList.toggle('on', !!isOn);
                statusBadge.textContent = isOn ? '已开启' : '已关闭';
                statusBadge.style.background = isOn ? 'rgba(126,252,134,.12)' : 'rgba(255,107,107,.12)';
                statusBadge.style.borderColor = isOn ? 'rgba(126,252,134,.35)' : 'rgba(255,107,107,.35)';
                setFavicon(!!isOn);
            }

            function buildChart(labels, temps, hums) {
                const ctx = document.getElementById('chart');
                if (chart) { chart.destroy(); }
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels, datasets: [
                            { label: '温度 (°C)', data: temps, borderColor: '#e73e3e', backgroundColor: 'rgba(231,62,62,.15)', tension: .35, pointRadius: 3, yAxisID: 'yT', fill: true },
                            { label: '湿度 (%)', data: hums, borderColor: '#7dc3ff', backgroundColor: 'rgba(125,195,255,.12)', tension: .35, pointRadius: 3, yAxisID: 'yH', fill: true }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd7ff' } },
                            yT: { type: 'linear', position: 'left', grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#ffb3b3' } },
                            yH: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#b9dbff' } }
                        },
                        plugins: { legend: false, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
            }

            async function apiGetAggregator() {
                const res = await fetch('/api/');
                if (!res.ok) throw new Error('获取信息失败');
                return res.json();
            }
            async function apiCommand(status) {
                const res = await fetch('/api/command', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
                if (!res.ok) throw new Error('指令执行失败');
                return res.json();
            }
            async function apiMeasure() {
                const res = await fetch('/api/measure', { method: 'POST' });
                if (!res.ok) throw new Error('测量失败');
                return res.json();
            }

            function toSeries(measurements) {
                const safe = [...(measurements || [])];
                safe.sort((a, b) => new Date(a.ctime || 0) - new Date(b.ctime || 0));
                const labels = safe.map(x => formatTime(x.ctime || Date.now()));
                const temps = safe.map(x => Number(x.temprature ?? x.temperature ?? 0));
                const hums = safe.map(x => Number(x.humidity ?? 0));
                return { labels, temps, hums };
            }

            async function init() {
                try {
                    [btnOn, btnOff, btnMeasure].forEach(b => b.disabled = true);
                    const data = await apiGetAggregator();
                    const isOn = !!data.status;
                    setStatus(isOn);
                    const { labels, temps, hums } = toSeries(data.measurements || []);
                    maxPoints = Math.max((data.measurements || []).length || 10, 2);
                    buildChart(labels, temps, hums);
                    showToast('已同步最新状态');
                } catch (e) { console.error(e); showToast('初始化失败：' + (e.message || e)); }
                finally { [btnOn, btnOff, btnMeasure].forEach(b => b.disabled = false); }
            }

            btnOn.addEventListener('click', async () => {
                try { setLoading(btnOn, true); btnOff.disabled = true; btnMeasure.disabled = true; const r = await apiCommand(true); if (typeof r.status === 'boolean') { setStatus(true); showToast('空调已开启'); } else throw new Error('返回异常'); }
                catch (e) { showToast('开启失败：' + (e.message || e)); }
                finally { setLoading(btnOn, false); btnOff.disabled = false; btnMeasure.disabled = false; }
            });

            btnOff.addEventListener('click', async () => {
                try { setLoading(btnOff, true); btnOn.disabled = true; btnMeasure.disabled = true; const r = await apiCommand(false); if (typeof r.status === 'boolean') { setStatus(false); showToast('空调已关闭'); } else throw new Error('返回异常'); }
                catch (e) { showToast('关闭失败：' + (e.message || e)); }
                finally { setLoading(btnOff, false); btnOn.disabled = false; btnMeasure.disabled = false; }
            });

            btnMeasure.addEventListener('click', async () => {
                try {
                    setLoading(btnMeasure, true); btnOn.disabled = true; btnOff.disabled = true;
                    const m = await apiMeasure();
                    const newLabel = formatTime(m.ctime || Date.now());
                    const newTemp = Number(m.temprature ?? m.temperature ?? 0);
                    const newHum = Number(m.humidity ?? 0);
                    if (chart) {
                        const L = chart.data.labels.length || maxPoints;
                        if (chart.data.labels.length >= L) {
                            chart.data.labels.shift();
                            chart.data.datasets[0].data.shift();
                            chart.data.datasets[1].data.shift();
                        }
                        chart.data.labels.push(newLabel);
                        chart.data.datasets[0].data.push(newTemp);
                        chart.data.datasets[1].data.push(newHum);
                        chart.update();
                    }
                    showToast('测量完成');
                } catch (e) { showToast('测量失败：' + (e.message || e)); }
                finally { setLoading(btnMeasure, false); btnOn.disabled = false; btnOff.disabled = false; }
            });

            btnRefresh.addEventListener('click', () => {
                if (typeof init === 'function') {
                    btnRefresh.disabled = true;
                    init().finally(() => btnRefresh.disabled = false);
                }
            });

            init();
        })();
    </script>
</body>

</html>